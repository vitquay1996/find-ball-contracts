<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Find Ball</title>
        <!-- The Ethers Application Client Library -->
        <link rel="stylesheet" type="text/css" href="css/style.css" media="screen" />
        <script type="module"> 
            import { ethers } from "https://cdn-cors.ethers.io/lib/ethers-5.5.4.esm.min.js";
            
            var userAddress;
            var gameMasterContract;
            var gameBoardContract;
            var provider;
            var signer;

            async function main() {
                provider = new ethers.providers.Web3Provider(window.ethereum)
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                document.getElementById("account").innerText = userAddress;

                await checkBalance();

                // Our contract
                var gameMasterAddress = '0xe7f1725e7734ce288f8367e1bb143e90bb3f0512';
                var gameMasterABI = [{"inputs":[{"internalType":"uint256","name":"_entryCommission","type":"uint256"},{"internalType":"contract BallBoard","name":"ballBoardContractAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"endGame","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getContractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"getEntryCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"getGameRunning","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"getNumPlayers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"getOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"getPrizePool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"getWinner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"numCups","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"},{"internalType":"uint8","name":"playerGuess","type":"uint8"}],"name":"play","outputs":[{"internalType":"bool","name":"isGuessCorrect","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newEntryCost","type":"uint256"}],"name":"startGame","outputs":[{"internalType":"uint256","name":"newGameId","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"gameId","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];

                gameMasterContract = new ethers.Contract(gameMasterAddress, gameMasterABI, signer);
                window.gameMasterContract = gameMasterContract;

                var gameBoardAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3"
                var gameBoardABI = [{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newBoardId","type":"uint256"}],"name":"boardCreated","type":"event"},{"inputs":[{"internalType":"uint8","name":"size","type":"uint8"}],"name":"createBoard","outputs":[{"internalType":"uint256","name":"newBoardId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"boardId","type":"uint256"}],"name":"getBallBoard","outputs":[{"internalType":"bool[]","name":"","type":"bool[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"boardId","type":"uint256"}],"name":"getRevealBoard","outputs":[{"internalType":"bool[]","name":"","type":"bool[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"boardId","type":"uint256"},{"internalType":"uint8","name":"location","type":"uint8"}],"name":"isRevealed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"numBoards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"boardId","type":"uint256"},{"internalType":"uint8","name":"location","type":"uint8"}],"name":"revealCup","outputs":[{"internalType":"bool","name":"isBall","type":"bool"}],"stateMutability":"nonpayable","type":"function"}]
                gameBoardContract = new ethers.Contract(gameBoardAddress, gameBoardABI, signer);
                window.gameBoardContract = gameBoardContract;
                
                await getGameStatus(0);
            }

            async function checkBalance() {
                let balance = await provider.getBalance(userAddress);
                balance = ethers.utils.formatEther(balance);
                console.log("Check Balance: "+balance);
            }

            async function startGame(entryCommission) {
                const startGame1 = await gameMasterContract.startGame(entryCommission, {value: ethers.utils.parseEther("0.5")});
                const receipt = await startGame1.wait();
                console.log(`Transaction confirmed in block ${receipt.blockNumber}`);
                console.log(receipt);
                var gameId = Number(receipt.logs[0].data);
                document.getElementById("gameIdInput").value = gameId;
                await getGameStatus(gameId);
            }

            async function play(id, guess, betAmount) {
                const playGuess = await gameMasterContract.play(id, guess, {value: ethers.utils.parseEther(betAmount)})
                const receipt = await playGuess.wait();
                console.log(`Transaction confirmed in block ${receipt.blockNumber}`);
                console.log(receipt);
                await getGameStatus(id);
                document.getElementById("cup" + (guess + 1).toString()).src = "images/cup-reveal.png";
            }

            async function endGame(id) {
                const endGame = await gameMasterContract.endGame(id);
                const receipt = await endGame.wait();
                console.log(`Transaction confirmed in block ${receipt.blockNumber}`);
                console.log(receipt);
                await getGameStatus(id);
                await checkBalance();
            }
            
            async function getGameReveal(id) {
                const gameReveal = await gameBoardContract.getRevealBoard(id);
                console.log(gameReveal);
                for (var i = 0; i < 8; i++) {
                    var j = i + 1;
                    if (gameReveal[i]) {
                        document.getElementById("cup" + j.toString()).src = "images/cup-reveal.png";
                    } else {
                        document.getElementById("cup" + j.toString()).src = "images/cup.png";
                    }
                }
            }

            async function getGameStatus(id) {
                const isGameRunning = await gameMasterContract.getGameRunning(id);
                const loadRevealed = await getGameReveal(id);
                console.log("Game " + id + " status is " + isGameRunning);
                if (isGameRunning) {
                    document.getElementById("gamestatus").innerHTML = "";
                } else {
                    document.getElementById("gamestatus").innerHTML = "not ";
                }
                await prizePoolRefresh();
                const getWinner = await gameMasterContract.getWinner(id);
                if (getWinner != "0x0000000000000000000000000000000000000000") {
                    document.getElementById("winner").innerHTML = "Winner: " + getWinner;
                    document.getElementById("winner").style = "";
                    document.getElementById("btnWithdraw").style = "";
                } else {
                    document.getElementById("winner").style = "display: none;";
                    document.getElementById("btnWithdraw").style = "display: none;";
                }
            }

            async function playerSelectedCup(num) {
                var id = document.getElementById("gameIdInput").value;
                const isGameRunning = await gameMasterContract.getGameRunning(id);
                if (isGameRunning && document.getElementById("cup" + (num + 1).toString()).src != "images/cup-reveal.png") {
                    let entryCost = await gameMasterContract.getEntryCost(id);
                    console.log(entryCost.toString());
                    await play(id, num, ethers.utils.formatEther(entryCost.toString()));
                }
            }

            async function prizePoolRefresh() {
                let prizePool = await gameMasterContract.getPrizePool(document.getElementById("gameIdInput").value);
                console.log(prizePool.toString());
                document.getElementById("pot").innerHTML = ethers.utils.formatEther(prizePool.toString());
            }

            document.getElementById("btnStartGame").onclick = async () => {
                await startGame(1000000000000000);
                await prizePoolRefresh();
            }

            document.getElementById("gameIdInput").onchange = async () => {
                var gameID = document.getElementById("gameIdInput").value;
                await getGameStatus(gameID);
            }

            document.getElementById("cup1").onclick = async () => {
                await playerSelectedCup(0);
            }

            document.getElementById("cup2").onclick = async () => {
                await playerSelectedCup(1);
            }

            document.getElementById("cup3").onclick = async () => {
                await playerSelectedCup(2);
            }

            document.getElementById("cup4").onclick = async () => {
                await playerSelectedCup(3);
            }

            document.getElementById("cup5").onclick = async () => {
                await playerSelectedCup(4);
            }

            document.getElementById("cup6").onclick = async () => {
                await playerSelectedCup(5);
            }

            document.getElementById("cup7").onclick = async () => {
                await playerSelectedCup(6);
            }

            document.getElementById("cup8").onclick = async () => {
                await playerSelectedCup(7);
            }

            document.getElementById("btnWithdraw").onclick = async () => {
                var gameID = document.getElementById("gameIdInput").value;
                await endGame(gameID);
            }

            main()
                .then()
                .catch((error) => {
                    console.error(error);
                });

        </script>
    </head>
    <body>
        <div>Account: <a id="account">Loading</a></div><br><br><br>
        <div id="divtitle">The game is <span id="gamestatus">not </span>active</div><br><br>
        <div id="divpot">Pot Money: <span id="pot">0</span> ETH</div><br><br>
        <div id="game">
            <img class="cup" src="images/cup.png" id="cup1">
            <img class="cup" src="images/cup.png" id="cup2">
            <img class="cup" src="images/cup.png" id="cup3">
            <img class="cup" src="images/cup.png" id="cup4">
            <img class="cup" src="images/cup.png" id="cup5">
            <img class="cup" src="images/cup.png" id="cup6">
            <img class="cup" src="images/cup.png" id="cup7">
            <img class="cup" src="images/cup-reveal.png" id="cup8">
            <div class="ball"></div>
            <div id="game-result"></div>
        </div>

        <br><br><br><br><div>Click a cup to guess the ball's position</div><br><br>
        <label>Game ID: </label><input id="gameIdInput" value="0"><br><br><button id="btnStartGame">Start New Game</button><br><br>
        <div id="winner" style="display: none;">Winner: </div><br><button id="btnWithdraw" style="display: none;">Withdraw</button>
    </body>
</html>

